cmake_minimum_required(VERSION 3.20)
project(ChoirV2 VERSION 2.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Build options
option(CHOIR_V2_BUILD_TESTS "Build unit tests" OFF)
option(CHOIR_V2_BUILD_BENCHMARKS "Build performance benchmarks" ON)
option(CHOIR_V2_ENABLE_SIMD "Enable SIMD optimizations" ON)
option(CHOIR_V2_BUILD_PLUGIN "Build JUCE plugin" ON)
option(CHOIR_V2_PLUGIN_FORMATS "Plugin formats to build" "VST3;AU;CLAP;LV2;Standalone")

# Compiler flags
if(MSVC)
    add_compile_options(/W4 /WX)
else()
    add_compile_options(-Wall -Wextra -Wpedantic -Werror)
endif()

# SIMD support
if(CHOIR_V2_ENABLE_SIMD)
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "arm64|aarch64")
        # ARM NEON support (automatically enabled on ARM64)
        # No special flags needed for NEON on modern compilers
    elseif(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
        # x86_64 AVX2 support
        add_compile_options(-mavx2 -mfma)
    elseif(MSVC)
        add_compile_options(/arch:AVX2)
    endif()
endif()

# Source files
set(CORE_SOURCES
    src/core/PhonemeDatabase.cpp
    src/core/LanguageLoader.cpp
    src/core/G2PEngine.cpp
    src/core/ChoirV2Engine.cpp
    src/core/VoiceManager.cpp
    src/core/VoiceAllocator.cpp
    src/core/PresetManager.cpp
)

set(SYNTHESIS_SOURCES
    src/synthesis/FormantSynthesis.cpp
    src/synthesis/SubharmonicSynthesis.cpp
    src/synthesis/DiphoneSynthesis.cpp
)

set(DSP_SOURCES
    src/dsp/FormantResonator.cpp
    src/dsp/GlottalSource.cpp
    src/dsp/LinearSmoother.cpp
    src/dsp/SpectralEnhancer.cpp
    src/dsp/SubharmonicGenerator.cpp
    src/dsp/ReverbEffect.cpp
)

set(UTILS_SOURCES
    src/utils/SIMDHelpers.cpp
    src/utils/MemoryPool.cpp
)

# Plugin source files
set(PLUGIN_SOURCES
    src/plugin/ChoirV2Processor.cpp
    src/plugin/ChoirV2Editor.cpp
)

set(PLUGIN_HEADERS
    src/plugin/ChoirV2Processor.h
    src/plugin/ChoirV2Editor.h
)

# Header files
set(HEADERS
    src/core/PhonemeDatabase.h
    src/core/LanguageLoader.h
    src/core/G2PEngine.h
    src/core/ChoirV2Engine.h
    src/core/VoiceManager.h
    src/core/VoiceAllocator.h
    src/core/PresetManager.h
    src/synthesis/FormantSynthesis.h
    src/synthesis/SubharmonicSynthesis.h
    src/synthesis/DiphoneSynthesis.h
    src/synthesis/ISynthesisMethod.h
    src/dsp/FormantResonator.h
    src/dsp/GlottalSource.h
    src/dsp/LinearSmoother.h
    src/dsp/SpectralEnhancer.h
    src/dsp/SubharmonicGenerator.h
    src/dsp/ReverbEffect.h
    src/utils/SIMDHelpers.h
    src/utils/MemoryPool.h
    src/utils/LockFreeQueue.h
    ${PLUGIN_HEADERS}
)

# Find nlohmann/json for JSON parsing
find_package(nlohmann_json 3.11.2 REQUIRED)

# Core library
add_library(ChoirV2Core STATIC
    ${CORE_SOURCES}
    ${SYNTHESIS_SOURCES}
    ${DSP_SOURCES}
    ${UTILS_SOURCES}
    ${HEADERS}
)

target_include_directories(ChoirV2Core PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/src
)

# Link nlohmann/json for JSON parsing
target_link_libraries(ChoirV2Core PUBLIC
    nlohmann_json::nlohmann_json
)

# Tests
if(CHOIR_V2_BUILD_TESTS)
    enable_testing()
    find_package(GTest REQUIRED)

    add_subdirectory(tests)
endif()

# Benchmarks
if(CHOIR_V2_BUILD_BENCHMARKS)
    # Add Google Benchmark support here
    # find_package(benchmark REQUIRED)
    # add_subdirectory(tests/benchmarks)
endif()

# JUCE Plugin
if(CHOIR_V2_BUILD_PLUGIN)
    # Find JUCE
    # Note: JUCE 8.0.0 uses individual module headers
    # You need to set JUCE_DIR environment variable or pass JUCE_PATH to CMake

    # Try to find JUCE in common locations
    if(NOT JUCE_PATH)
        if(EXISTS "$ENV{JUCE_DIR}")
            set(JUCE_PATH "$ENV{JUCE_DIR}")
        elseif(EXISTS "$ENV{HOME}/JUCE")
            set(JUCE_PATH "$ENV{HOME}/JUCE")
        elseif(EXISTS "/usr/local/JUCE")
            set(JUCE_PATH "/usr/local/JUCE")
        elseif(EXISTS "/opt/JUCE")
            set(JUCE_PATH "/opt/JUCE")
        endif()
    endif()

    if(EXISTS "${JUCE_PATH}")
        message(STATUS "Found JUCE at: ${JUCE_PATH}")

        # Add JUCE subdirectory
        add_subdirectory("${JUCE_PATH}" "${CMAKE_BINARY_DIR}/juce")

        # Create JUCE plugin
        juce_add_plugin(ChoirV2Plugin
            COMPANY_NAME "Bret Bouchard"
            PLUGIN_MANUFACTURER_CODE "BBbr"
            PLUGIN_CODE "ChV2"
            FORMATS ${CHOIR_V2_PLUGIN_FORMATS}
            PRODUCT_NAME "Choir V2.0"
            VERSION ${PROJECT_VERSION}
            IS_SYNTH TRUE
            NEEDS_MIDI_INPUT TRUE
            NEEDS_MIDI_OUTPUT FALSE
            IS_MIDI_EFFECT FALSE
            VST_NUM_MIDI_INPUTS 16
            VST_NUM_MIDI_OUTPUTS 0
            AU_MAIN_TYPE "aumu"
            LV2_URI "https://bretbouchard.github.io/choir-v2-universal"
            LV2_CATEGORY "Instrument"
            COPY_PLUGIN_AFTER_BUILD TRUE
        )

        # Plugin sources
        target_sources(ChoirV2Plugin PRIVATE
            ${PLUGIN_SOURCES}
            ${CORE_SOURCES}
            ${SYNTHESIS_SOURCES}
            ${DSP_SOURCES}
            ${UTILS_SOURCES}
            ${HEADERS}
        )

        # Include directories
        target_include_directories(ChoirV2Plugin PRIVATE
            ${CMAKE_CURRENT_SOURCE_DIR}/src
        )

        # Link dependencies
        target_link_libraries(ChoirV2Plugin PRIVATE
            ChoirV2Core
            nlohmann_json::nlohmann_json
            juce::juce_audio_utils
            juce::juce_dsp
        )

        # Output directories for plugins
        set_target_properties(ChoirV2Plugin PROPERTIES
            ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/artifacts"
            LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/artifacts"
            RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/artifacts"
        )

        # Plugin-specific output directories
        if(TARGET ChoirV2Plugin_VST3)
            set_target_properties(ChoirV2Plugin_VST3 PROPERTIES
                LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/plugins/vst"
            )
        endif()

        if(TARGET ChoirV2Plugin_AU)
            set_target_properties(ChoirV2Plugin_AU PROPERTIES
                LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/plugins/au"
            )
        endif()

        if(TARGET ChoirV2Plugin_CLAP)
            set_target_properties(ChoirV2Plugin_CLAP PROPERTIES
                LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/plugins/clap"
            )
        endif()

        if(TARGET ChoirV2Plugin_LV2)
            set_target_properties(ChoirV2Plugin_LV2 PROPERTIES
                LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/plugins/lv2"
            )
        endif()

        if(TARGET ChoirV2Plugin_Standalone)
            set_target_properties(ChoirV2Plugin_Standalone PROPERTIES
                RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/plugins/standalone"
            )
        endif()

        message(STATUS "JUCE Plugin: Enabled")
        message(STATUS "  Formats: ${CHOIR_V2_PLUGIN_FORMATS}")
    else()
        message(WARNING "JUCE not found. Plugin build disabled.")
        message(WARNING "Set JUCE_PATH environment variable or pass -DJUCE_PATH=/path/to/JUCE")
    endif()
endif()

# Installation
install(TARGETS ChoirV2Core
    ARCHIVE DESTINATION lib
    LIBRARY DESTINATION lib
    RUNTIME DESTINATION bin
)

install(FILES ${HEADERS}
    DESTINATION include/ChoirV2
)

# Print configuration
message(STATUS "")
message(STATUS "Choir V2.0 Configuration:")
message(STATUS "  Version: ${PROJECT_VERSION}")
message(STATUS "  Build Tests: ${CHOIR_V2_BUILD_TESTS}")
message(STATUS "  Build Benchmarks: ${CHOIR_V2_BUILD_BENCHMARKS}")
message(STATUS "  Build Plugin: ${CHOIR_V2_BUILD_PLUGIN}")
message(STATUS "  Enable SIMD: ${CHOIR_V2_ENABLE_SIMD}")
if(CHOIR_V2_BUILD_PLUGIN)
    message(STATUS "  Plugin Formats: ${CHOIR_V2_PLUGIN_FORMATS}")
endif()
message(STATUS "")
